<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ì£¼ë¬¸/ê²°ì œ</title>
<style>
  :root{
    --bg:#faf9fb; --card:#ffffff; --ink:#1d1b20;
    --border:#ece7f6; --muted:#8a829b;
    --accent:#6b47d6;               /* ë³´ë¼ ë²„íŠ¼ */
    --accent-ghost:#efeaff;         /* ì—°ë³´ë¼ ë°°ê²½ */
    --shadow:0 10px 30px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif}

  .wrap{max-width:920px;margin:0 auto;padding:24px 18px 120px}

  /* í—¤ë” */
  .top{display:flex;align-items:center;gap:12px;margin-bottom:18px}
  .back{all:unset;cursor:pointer;border:1px solid var(--border);border-radius:10px;padding:6px 10px;background:#fff}
  h1{margin:0;font-size:20px}

  /* ì¹´ë“œ */
  .card{
    background:var(--card);border:1px solid var(--border);border-radius:14px;
    padding:16px;box-shadow:0 1px 8px rgba(0,0,0,.03);margin-bottom:14px;
  }
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .muted{color:var(--muted)}
  .tag{display:inline-flex;align-items:center;gap:6px;border-radius:999px;
       padding:3px 8px;background:#fff5c2;border:1px solid #ffe79b;font-size:12px}
  .dropdown{width:100%;border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff}

  .item{display:flex;align-items:center;gap:12px}
  .thumb{width:56px;height:56px;border-radius:10px;border:1px solid var(--border);object-fit:cover;background:#f3f1fa}

  /* í¬ì¸íŠ¸ */
  .point-area{display:grid;grid-template-columns:1fr 140px; gap:12px;align-items:center}
  .point-input{border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:#fff;text-align:right}
  .point-input::-webkit-outer-spin-button,.point-input::-webkit-inner-spin-button{appearance:none;margin:0}
  .btn-ghost{all:unset;cursor:pointer;text-align:center;border:1px solid var(--border);border-radius:12px;
             padding:12px;background:var(--accent-ghost);}

  .notice{display:flex;align-items:center;gap:10px;border:1px solid #ffd8e1;background:#fff1f4;color:#e2556a;
          border-radius:12px;padding:12px 14px;margin:12px 0}

  /* í•˜ë‹¨ ê²°ì œ ë°” */
  .paybar{
    position:fixed;left:0;right:0;bottom:0;background:rgba(250,249,251,.85);backdrop-filter:saturate(120%) blur(6px);
    border-top:1px solid var(--border);padding:12px 16px;z-index:50;
  }
  .pay-inner{max-width:920px;margin:0 auto}
  .pay-btn{
    width:100%;height:56px;border-radius:12px;border:1px solid #d9cff7;
    background:linear-gradient(0deg,#6b47d6,#7a5cf0);
    color:#fff;font-weight:800;font-size:18px;letter-spacing:.2px;cursor:pointer;
    display:flex;align-items:center;justify-content:center;gap:8px;position:relative;
    box-shadow:0 12px 24px rgba(107,71,214,.28);
  }
  .ship-pill{
    position:absolute;right:10px;top:-10px;background:#fff3dc;border:1px solid #ffe0a6;
    color:#4d3a00;border-radius:999px;padding:4px 8px;font-size:12px;font-weight:700;
  }

  /* í•©ê³„ í‘œ */
  .totals{max-width:920px;margin:14px auto 0;color:#433c55}
  .totals .line{display:flex;justify-content:space-between;padding:6px 4px}
  .totals .all{font-size:18px;font-weight:800}

  /* ì™„ë£Œ ëª¨ë‹¬ */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:60}
  .modal.show{display:flex}
  .sheet{width:min(420px,90%);background:#fff;border-radius:18px;border:1px solid var(--border);box-shadow:var(--shadow);
         padding:22px}
  .sheet h3{margin:0 0 8px}
  .sheet p{margin:0 0 18px;color:#605a6e}
  .sheet .actions{display:flex;gap:10px;justify-content:flex-end}
  .btn{all:unset;cursor:pointer;background:#fff;border:1px solid var(--border);padding:10px 14px;border-radius:10px}
  .btn.primary{background:linear-gradient(0deg,#6b47d6,#7a5cf0);color:#fff;border-color:#d9cff7}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <!-- 1) ì´ì „ ë²„íŠ¼: ì „ í˜ì´ì§€ ì´ë™ -->
      <button class="back" onclick="history.back()">â† ì´ì „</button>
      <h1>ì£¼ë¬¸/ê²°ì œ</h1>
    </div>

    <!-- ì£¼ë¬¸ìƒí’ˆ -->
    <section class="card" id="orderCard">
      <div class="row">
        <div>
          <strong>ì£¼ë¬¸ìƒí’ˆ ì´ <span id="itemCnt">1</span>ê°œ</strong>
          <span class="tag">ë¬´ë£Œë°°ì†¡</span>
        </div>
        <div class="muted" id="orderFold" style="cursor:pointer">â–¾</div>
      </div>
      <div id="orderList" style="margin-top:10px">
        <div class="item">
          <img id="firstThumb" class="thumb" alt="ìƒí’ˆ ì´ë¯¸ì§€">
          <div style="flex:1">
            <div><b id="firstName">ìƒí’ˆ</b></div>
            <div class="muted"><span id="firstQty">1</span>ê°œ Â· <span id="firstPrice">0</span>ì›</div>
          </div>
          <div><b id="firstSum">0</b>ì›</div>
        </div>
      </div>
    </section>

    <!-- ë°°ì†¡ì§€ -->
    <section class="card">
      <div class="row">
        <b>ë°°ì†¡ì§€</b>
        <!-- 2) ë³€ê²½í•˜ê¸°: promptë¡œ ì •ë³´ ìˆ˜ì •(ì§ì „ ë™ì‘ ë³µì›) -->
        <a href="#" class="muted" onclick="openAddrEdit(event)">ë³€ê²½í•˜ê¸°</a>
      </div>
      <div style="margin-top:10px">
        <div id="recvName"><b>í—ˆêµ¬</b></div>
        <div id="recvPhone" class="muted">010-1234-4566</div>
        <div id="recvAddr" class="muted">ì†”ë°ìŠ¤í¬</div>
      </div>
      <select class="dropdown" style="margin-top:12px">
        <option>ë°°ì†¡ ì‹œ ìš”ì²­ì‚¬í•­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
        <option>ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”</option>
        <option>ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”</option>
        <option>ë¶€ì¬ ì‹œ ì—°ë½ ë¶€íƒë“œë¦½ë‹ˆë‹¤</option>
      </select>
    </section>

    <!-- ê²°ì œ/í¬ì¸íŠ¸ -->
    <section class="card">
      <b>ê²°ì œ</b>
      <div class="row" style="margin-top:12px">
        <div>í¬ì¸íŠ¸</div>
        <div class="point-area">
          <input id="pointInput" class="point-input" type="number" min="0" value="0" />
          <button id="useAll" class="btn-ghost">ëª¨ë‘ ì‚¬ìš©</button>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">
        ì‚¬ìš© ê°€ëŠ¥ : <span id="canUse">0</span>ì› | ë³´ìœ  í¬ì¸íŠ¸ : <span id="ownPt">0</span>ì›
      </div>
    </section>

    <div class="notice">ğŸª™ ì§€ê¸ˆ ì£¼ë¬¸í•˜ë©´ ë” ì•„ê»´ìš”!</div>

    <!-- í•©ê³„ -->
    <div class="totals">
      <div class="line"><span>ìƒí’ˆ í•©ê³„</span><span id="sumLine">0ì›</span></div>
      <div class="line"><span>í¬ì¸íŠ¸ ì‚¬ìš©</span><span id="ptLine">-0ì›</span></div>
      <div class="line all"><span>ê²°ì œ ê¸ˆì•¡</span><span id="payLine">0ì›</span></div>
    </div>
  </div>

  <!-- í•˜ë‹¨ ê²°ì œ ë²„íŠ¼ -->
  <div class="paybar">
    <div class="pay-inner">
      <button id="payBtn" class="pay-btn" type="button">
        <span id="payAmtText">0</span> ì› ê²°ì œí•˜ê¸°
        <span class="ship-pill">ë¬´ë£Œë°°ì†¡ ğŸšš</span>
      </button>
    </div>
  </div>

  <!-- ê²°ì œ ì™„ë£Œ ëª¨ë‹¬ -->
  <div id="doneModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="doneTitle">
    <div class="sheet">
      <h3 id="doneTitle">ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ‰</h3>
      <p>ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆì–´ìš”. ë§ˆì´í˜ì´ì§€ì—ì„œ ì£¼ë¬¸ë‚´ì—­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <div class="actions">
        <button class="btn" onclick="location.href='mypage.html'">ì£¼ë¬¸ë‚´ì—­ ë³´ê¸°</button>
        <button class="btn primary" onclick="location.href='main.html'">ë©”ì¸ìœ¼ë¡œ</button>
      </div>
    </div>
  </div>

<script>
  /* ===== ìœ í‹¸ ===== */
  const fmt = n => (n||0).toLocaleString('ko-KR');
  const getCart = () => { try{return JSON.parse(localStorage.getItem('cart'))||[]}catch(e){return[]} };

  /* ===== ì´ˆê¸° ë°ì´í„° ===== */
  const ownPoints = Number(localStorage.getItem('points_balance')) || 35000;   // ë³´ìœ  í¬ì¸íŠ¸(ì˜ˆì‹œ)
  const cart = getCart();

  // í•©ê³„(ì¥ë°”êµ¬ë‹ˆ ê¸°ë°˜, ì—†ìœ¼ë©´ payment_total ì‚¬ìš©, ê·¸ê²ƒë„ ì—†ìœ¼ë©´ 0)
  let total = cart.reduce((s,i)=>s + (Number(i.price)||0)*(Number(i.qty)||1), 0);
  if(!total) total = Number(localStorage.getItem('payment_total')) || 0;

  // ì£¼ë¬¸ íŒ¨ë„ ì±„ìš°ê¸° + ì´ë¯¸ì§€ ë³´ì´ë„ë¡ (ìš”ì²­ 3)
  (function fillItem(){
    const imgEl = document.getElementById('firstThumb');
    const nameEl= document.getElementById('firstName');
    const qtyEl = document.getElementById('firstQty');
    const priceEl=document.getElementById('firstPrice');
    const sumEl  =document.getElementById('firstSum');
    const cntEl  =document.getElementById('itemCnt');

    if(cart.length){
      const it = cart[0];
      const qty = Number(it.qty)||1, price = Number(it.price)||0;
      // ë‹¤ì–‘í•œ í‚¤ ì´ë¦„ì— ëŒ€ì‘
      const imgSrc = it.image || it.img || it.thumbnail || it.thumb || '';
      imgEl.src = imgSrc || 'data:image/svg+xml;utf8,' + encodeURIComponent(
        '<svg xmlns="http://www.w3.org/2000/svg" width="56" height="56"><rect width="100%" height="100%" fill="#efeaff"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="10" fill="#6b47d6">ìƒí’ˆ</text></svg>'
      );
      imgEl.alt = (it.name||'ìƒí’ˆ') + ' ì´ë¯¸ì§€';

      nameEl.textContent = it.name || 'ìƒí’ˆ';
      qtyEl.textContent  = qty;
      priceEl.textContent= fmt(price);
      sumEl.textContent  = fmt(price*qty);
      cntEl.textContent  = cart.reduce((s,x)=>s+(Number(x.qty)||1),0);
    }else{
      // ë¹„ì–´ìˆì„ ë•Œë„ í•©ê³„/ë²„íŠ¼ ê¸ˆì•¡ì€ í‘œì‹œ
      imgEl.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(
        '<svg xmlns="http://www.w3.org/2000/svg" width="56" height="56"><rect width="100%" height="100%" fill="#efeaff"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="10" fill="#6b47d6">ìƒí’ˆ</text></svg>'
      );
      imgEl.alt = 'ìƒí’ˆ ì´ë¯¸ì§€';
    }
  })();

  // í•©ê³„ ì˜ì—­ í‘œì‹œ
  document.getElementById('sumLine').textContent = fmt(total)+'ì›';
  document.getElementById('payLine').textContent = fmt(total)+'ì›';
  document.getElementById('payAmtText').textContent = fmt(total);
  document.getElementById('canUse').textContent = fmt(Math.min(total, ownPoints));
  document.getElementById('ownPt').textContent = fmt(ownPoints);

  /* ì£¼ë¬¸ ë¦¬ìŠ¤íŠ¸ ì ‘ê¸°/í¼ì¹˜ê¸° */
  document.getElementById('orderFold').addEventListener('click',()=>{
    const box = document.getElementById('orderList');
    box.style.display = (box.style.display==='none'?'block':'none');
  });

  /* ===== í¬ì¸íŠ¸ ì‚¬ìš© ===== */
  const pointInput = document.getElementById('pointInput');
  const useAllBtn   = document.getElementById('useAll');
  const ptLine = document.getElementById('ptLine');
  const payLine = document.getElementById('payLine');
  const payAmtText = document.getElementById('payAmtText');

  function clampPoint(v){
    v = Math.max(0, Math.floor(Number(v)||0));
    const maxUse = Math.min(total, ownPoints);
    return Math.min(v, maxUse);
  }
  function updatePay(){
    const use = clampPoint(pointInput.value);
    pointInput.value = use;
    const pay = Math.max(0, total - use);
    ptLine.textContent = '-' + fmt(use) + 'ì›';
    payLine.textContent = fmt(pay) + 'ì›';
    payAmtText.textContent = fmt(pay);
    document.getElementById('canUse').textContent = fmt(Math.min(total, ownPoints));
  }
  useAllBtn.addEventListener('click', ()=>{
    pointInput.value = Math.min(total, ownPoints);
    updatePay();
  });
  pointInput.addEventListener('input', updatePay);
  updatePay();

  /* ===== ë°°ì†¡ì§€ ë³€ê²½ (ì§ì „ ë°©ì‹ ìœ ì§€) ===== */
  function openAddrEdit(e){
    e.preventDefault();
    const name = prompt('ìˆ˜ë ¹ì¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', document.getElementById('recvName').innerText.trim());
    if(name!==null){ document.getElementById('recvName').innerHTML = '<b>'+name+'</b>'; }
    const phone = prompt('ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”', document.getElementById('recvPhone').innerText.trim());
    if(phone!==null){ document.getElementById('recvPhone').textContent = phone; }
    const addr = prompt('ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”', document.getElementById('recvAddr').innerText.trim());
    if(addr!==null){ document.getElementById('recvAddr').textContent = addr; }
  }
  window.openAddrEdit = openAddrEdit;

  /* ===== ê²°ì œ ì²˜ë¦¬(ëª¨ë‹¬) ===== */
  const modal = document.getElementById('doneModal');
  document.getElementById('payBtn').addEventListener('click', ()=>{
    const btn = document.getElementById('payBtn');
    const old = btn.innerHTML;
    btn.innerHTML = 'ê²°ì œ ì²˜ë¦¬ì¤‘â€¦';
    btn.disabled = true;

    setTimeout(()=>{
      // í¬ì¸íŠ¸ ì°¨ê° ì‹œë®¬ë ˆì´ì…˜
      const used = clampPoint(pointInput.value);
      const remain = Math.max(0, (Number(localStorage.getItem('points_balance'))||ownPoints) - used);
      localStorage.setItem('points_balance', remain.toString());

      btn.disabled = false;
      btn.innerHTML = old;
      modal.classList.add('show');
    }, 900);
  });

  // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë‹«ê¸°
  modal.addEventListener('click',(e)=>{ if(e.target===modal){ modal.classList.remove('show'); }});
</script>
</body>
</html>
